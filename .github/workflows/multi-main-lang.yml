name: "multi-main-lang ‚Äî 3OS Build + Auto-Source + C++ Transpile + ProofLedger"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: multi-main-lang-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Normalize Line Endings (non-Windows)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Setup C++ Environment (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update -y || true
          sudo apt-get install -y g++

      - name: Setup C++ Environment (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          brew install gcc || true

      - name: Setup C++ Environment (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install mingw -y
          echo "PATH=C:\\tools\\mingw64\\bin;$env:PATH" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8

      ##############################################################
      # üî• 1) Auto Source Generation ‚Äî Ïã§Ï†ú Ïñ∏Ïñ¥ ÏõêÎ≥∏ ÏûêÎèô ÏÉùÏÑ±
      ##############################################################
      - name: Auto Generate Source (multi-main-lang .mml)
        shell: bash
        run: |
          mkdir -p src/auto
          cat <<EOF > src/auto/main.mml
// multi-main-lang experimental source
// auto-generated by GitHub Actions
func main:
    print("Hello from multi-main-lang!")
EOF

      ##############################################################
      # üî• 2) Auto Generate C++ from the auto source (Mini Transpiler Mock)
      ##############################################################
      - name: Auto Transpile (Generate gen.cpp)
        shell: bash
        run: |
          mkdir -p src/auto
          cat <<EOF > src/auto/gen.cpp
// Generated C++ from multi-main-lang transpiler
#include <iostream>
int auto_main() {
    std::cout << "Hello from auto-generated C++!" << std::endl;
    return 0;
}
EOF

      ##############################################################
      # üî• 3) Final out.cpp (C++ build target)
      ##############################################################
      - name: Generate Final Transpiled C++ (out.cpp)
        shell: bash
        run: |
          mkdir -p dist
          cat <<EOF > dist/out.cpp
// final transpiled C++ (combined)
#include <iostream>
int auto_main();
int main() {
    return auto_main();
}
EOF

      ##############################################################
      # üî® 4) Build Executable
      ##############################################################
      - name: Build Executable
        shell: bash
        run: |
          cd dist
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            g++ out.cpp ../src/auto/gen.cpp -o out.exe
          else
            g++ out.cpp ../src/auto/gen.cpp -o out
          fi

      ##############################################################
      # üìú 5) ProofLedger
      ##############################################################
      - name: Generate ProofLedger
        shell: bash
        run: |
          cd dist
          echo "ProofLedger for multi-main-lang" > proofledger.txt
          echo "OS: ${{ runner.os }}" >> proofledger.txt
          echo "Commit: ${{ github.sha }}" >> proofledger.txt
          echo "Timestamp: $(date)" >> proofledger.txt
          echo "" >> proofledger.txt

          echo "[HASH] src/auto/main.mml" >> proofledger.txt
          (sha256sum ../src/auto/main.mml 2>/dev/null || shasum -a 256 ../src/auto/main.mml) >> proofledger.txt || true

          echo "[HASH] src/auto/gen.cpp" >> proofledger.txt
          (sha256sum ../src/auto/gen.cpp 2>/dev/null || shasum -a 256 ../src/auto/gen.cpp) >> proofledger.txt || true

          echo "[HASH] dist/out.cpp" >> proofledger.txt
          (sha256sum out.cpp 2>/dev/null || shasum -a 256 out.cpp) >> proofledger.txt || true

          echo "[HASH] binary" >> proofledger.txt
          (sha256sum out 2>/dev/null || true)
          (sha256sum out.exe 2>/dev/null || true)
          (shasum -a 256 out 2>/dev/null || true)
          (shasum -a 256 out.exe 2>/dev/null || true)

      ##############################################################
      # üì¶ 6) Upload OS Artifacts
      ##############################################################
      - name: Upload Artifacts (per OS)
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ runner.os }}
          path: |
            dist/*
            src/auto/main.mml
            src/auto/gen.cpp

  ##############################################################
  # üöÄ Release Job
  ##############################################################
  release:
    needs: build-3os
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Create Release Tag
        id: tag
        run: |
          VERSION="v1.0.$(date +%Y%m%d%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          git tag $VERSION
          git push origin $VERSION

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: releases

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.version }}
          files: releases/**/*
